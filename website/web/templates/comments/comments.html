{% extends "main.html" %}
{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='js/showdown.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/lodash.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/moment.min.js') }}"></script>
{% endblock %}
{% block title %}Comments{% endblock %}
{% block content %}
<h1>Recent comments</h1>
<div class="row text-right">
    <div class="col text-end">
        <a class="icon-link" href="{{ url_for('comments_bp.feed_comments', format='atom') }}" type="application/atom+xml" title="Atom feed">{{ render_icon('rss') }}</a>
        <a class="icon-link" href="{{ url_for('comments_bp.feed_comments', format='rss') }}" type="application/atom+xml" title="RSS feed">{{ render_icon('rss-fill') }}</a>
    </div>
</div>
<div id="list-comments">
    <div class="d-flex justify-content-center">
        <div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        var converter = new showdown.Converter()
        var commentTemplate = _.template(
        '<div class="card">' +
        '<div class="card-body">' +
        '<h5 class="card-title"><%= title %> on <%= vulnerability_id %></h5>' +
        '<h6 class="card-subtitle mb-2 text-body-secondary"><%= timestamp %> by <%= author %></h6>' +
        '<p class="card-text"><%= description %></p>' +
        '<p class="card-text">More details about <a href="/vuln/<%= vulnerability_id %>"><%= vulnerability_id %></a>.</p>' +
        '<% _.forEach(related_vulnerabilities, function(vuln) ' +
            '{ %><a href="/vuln/<%= vuln %>"><%- vuln %></a> <% }); %>',
        '</div>');
        fetch("{{ url_for('apiv1.comment_comments_list') }}")
        .then(response => response.json())
        .then(result => {
        document.getElementById("list-comments").innerHTML = "";
        if (result.metadata.count == 0) {
            document.getElementById("list-comments").innerHTML = "<p>No comment.</p>";
        }
        result.data
        .sort(function (a, b) {
            return new Date(b.updated_at) - new Date(a.updated_at);
        })
        .map(function (comment) {
            var cardHTML = commentTemplate({
            'id': comment.id,
            'title': comment.title,
            'description': converter.makeHtml(comment.description),
            'timestamp': moment(comment.timestamp).fromNow(),
            'vulnerability_id': comment.vulnerability,
            'related_vulnerabilities': comment.related_vulnerabilities,
            'author': comment.author.name
            });
            var element = document.createElement("div");
            var element_br = document.createElement("br");
            element.innerHTML = cardHTML;
            document.getElementById("list-comments").appendChild(element.firstChild);
            document.getElementById("list-comments").append(element_br);
        })
        })
        .catch((error) => {
        console.error('Error:', error);
        });
    });
</script>
{% endblock %}
