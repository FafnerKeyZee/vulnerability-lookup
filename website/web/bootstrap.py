#!/usr/bin/env python3

import os
from flask import Flask
from flask_bootstrap import Bootstrap5  # type: ignore[import-untyped]
from flask_migrate import Migrate
from flask_sqlalchemy import SQLAlchemy

from vulnerabilitylookup.vulnerabilitylookup import VulnerabilityLookup
from website import BASE_DIR
from website.web.helpers import sri_load

from .helpers import get_secret_key
from .proxied import ReverseProxied


application: Flask = Flask(__name__)

application.wsgi_app = ReverseProxied(application.wsgi_app)  # type: ignore

application.config["SECRET_KEY"] = get_secret_key()
application.config.from_pyfile(os.path.join(BASE_DIR, "config", "website.py"), silent=False)

Bootstrap5(application)

db = SQLAlchemy(application)
migrate = Migrate(application, db)


vulnerabilitylookup: VulnerabilityLookup = VulnerabilityLookup()


# ##### Global methods passed to jinja

def get_sri(directory: str, filename: str) -> str:
    sha512 = sri_load()[directory][filename]
    return f'sha512-{sha512}'


application.jinja_env.globals.update(get_sri=get_sri)


# ##### Jinja custom filters

def datetimeformat(value, format="%Y-%m-%d %H:%M"):
    return value.strftime(format)


application.jinja_env.filters["datetimeformat"] = datetimeformat
