{% extends "main.html" %}
{% from 'bootstrap5/utils.html' import render_messages %}
{% import 'vulnerability_templates.html' as vuln_templates %}

{% block title %}Recent vulnerabilities{% endblock %}

{%block navbar_links%}
<li class="nav-item">
  <a class="nav-link" href="{{url_for('search')}}">Search</a>
</li>
<li class="nav-item">
  <a class="nav-link active" href="{{url_for('recent')}}">Recent</a>
</li>
{% endblock%}

{% block content %}
<h1>Most recent vulnerabilities by source</h1>
<h6>The vulnerabilities are sorted by update time (recent to old)</h6>
<ul class="nav nav-tabs" id="vulnSourcesTab" role="tablist">
  {% for source, vulns in recent.items() if vulns %}
  <li class="nav-item" role="presentation">
      <button class="nav-link {% if source == default_source %}active{%endif%}" id="{{source}}-tab"
                                      data-bs-toggle="tab"
                                      data-bs-target="#{{source}}-tab-pane"
                                      type="button" role="tab"
                                      aria-controls="{{source}}-tab-pane"
                                      aria-selected="true">
		{{source}}
	  </button>
  </li>
  {%endfor%}
</ul>
<div class="tab-content" id="vulnSourcesTabContent">
  {% for source, vulns in recent.items() if vulns %}
  <div class="tab-pane fade show {% if source == 'cvelistv5' %} active {%endif%}"
       id="{{source}}-tab-pane" role="tabpanel" aria-labelledby="{{source}}-tab" tabindex="0">
	<table class="table">
	  <thead>
		<tr>
		  <th scope="col">Vulnerability ID</th>
		  <th scope="col">Description</th>
		</tr>
	  </thead>
	  <tbody>
	  {%for vuln in vulns %}
        {%if source == "cvelistv5" %}
        <tr>
          <th scope="row">
            <a href="{{url_for('vulnerability_view', vulnerability_id=vuln['cveMetadata']['cveId'])}}">{{vuln['cveMetadata']['cveId']}}</a>
            (<a href="https://nvd.nist.gov/vuln/detail/{{vuln['cveMetadata']['cveId']}}">NVD</a>)
          </th>
          <td>
            {% if vuln['containers']['cna']['title'] %}
              {{vuln['containers']['cna']['title']}}
            {% elif vuln['containers']['cna']['descriptions'] %}
              {{vuln['containers']['cna']['descriptions'][0]['value']}}
            {% else %}
              {{vuln['containers']['cna']}}
            {%endif%}
          </td>
        </tr>
		{%elif source == "github" %}
		<tr>
		  <th scope="row">
            <a href="{{url_for('vulnerability_view', vulnerability_id=vuln['id'])}}">{{vuln['id']}}</a>
			(<a href="https://github.com/advisories/{{vuln['id']}}">github</a>)
		  </th>
		  <td>{{vuln['details']}}</td>
		</tr>
        {%elif source == "pysec" %}
        <tr>
          <th scope="row">
              <a href="{{url_for('vulnerability_view', vulnerability_id=vuln['id'])}}">{{vuln['id']}}</a>
          </th>
          <td>{{vuln['details']}}</td>
        </tr>
        {%elif source == "gsd"%}
        <tr>
          <th scope="row">
              {% if 'GSD' in vuln %}
                  <a href="{{url_for('vulnerability_view', vulnerability_id=vuln['GSD']['id'])}}">{{vuln['GSD']['id']}}</a>
              {%elif 'gsd' in vuln %}
                  <a href="{{url_for('vulnerability_view', vulnerability_id=vuln['gsd']['osvSchema']['id'])}}">{{vuln['gsd']['osvSchema']['id']}}</a>
              {%else%}
              <tr>
                <td colspan="1">
                  <pre>{{vuln|tojson(indent=2)}}</pre>
                </td>
              </tr>
              {%endif%}
          </th>
          <td>The format of the source doesn't require a description, click on the link for more details</td>
        </tr>
		{%else%}
		<tr>
		  <td colspan="1">
			<pre>{{vuln|tojson(indent=2)}}</pre>
		  </td>
		</tr>
		{%endif%}
	  {%endfor%}
	  </tbody>
	</table>
  </div>
  {%endfor%}
</div>
{% endblock %}

{% block scripts %}
<!-- Optional JavaScript -->
{{ super() }}

<script type="text/javascript">

var tabs = document.querySelectorAll('button[data-bs-toggle="tab"]')
tabs.forEach(tab =>  {
    tab.addEventListener('click', (event) => {
        localStorage.setItem('lastTab', event.target.getAttribute('id'));
    });
})

var lastTab = localStorage.getItem('lastTab');

if (lastTab) {
  var t = document.getElementById(lastTab);
  var tab = new bootstrap.Tab(t)
  tab.show()
}
</script>
{% endblock %}
