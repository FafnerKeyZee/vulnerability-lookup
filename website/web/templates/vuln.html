{% extends "main.html" %}
{% import 'vulnerability_templates.html' as vuln_templates %}
{% import 'comment_templates.html' as comment_templates %}

{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='js/showdown.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/lodash.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/moment.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/jsoneditor.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/pretty-print-json.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/easymde.min.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/easymde.min.css') }}" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/pretty-print-json.css') }}" />
{% endblock %}

{% block title %}{{source}} - {{vulnerability_id}}{% endblock %}

{% block content %}

<div class="modal" id="modalError" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Action not permitted</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="modal-error-text">Modal body text goes here.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


{% if source ==  'nvd' %}
{{vuln_templates.nvd_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'cvelistv5' %}
{{vuln_templates.cvelistv5_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'circl' %}
{{vuln_templates.circl_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data, current_user=current_user)}}
{% elif source ==  'github' %}
{{vuln_templates.github_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'gsd' %}
{{vuln_templates.gsd_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'pysec' %}
{{vuln_templates.pysec_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'ossf_malicious_packages' %}
{{vuln_templates.ossf_malicious_packages_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'csaf_certbund' %}
{{vuln_templates.csaf_certbund_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'csaf_siemens' %}
{{vuln_templates.csaf_siemens_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'csaf_redhat' %}
{{vuln_templates.csaf_redhat_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'csaf_cisa' %}
{{vuln_templates.csaf_cisa_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'csaf_cisco' %}
{{vuln_templates.csaf_cisco_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'csaf_sick' %}
{{vuln_templates.csaf_sick_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'csaf_ox' %}
{{vuln_templates.csaf_ox_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'csaf_nozominetworks' %}
{{vuln_templates.csaf_nozominetworks_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'variot' %}
{{vuln_templates.variot_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{%elif source %}
Other source: {{source}}.
<pre>{{vulnerability_data|tojson(indent=2)}}</pre>
{% endif %}

<br />
<ul class="nav nav-tabs" id="pageTab" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="related-tab" data-bs-toggle="tab" data-bs-target="#related" type="button" role="tab" aria-controls="related" aria-selected="true">Related vulnerabilities</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="comments-tab" data-bs-toggle="tab" data-bs-target="#comments" type="button" role="tab" aria-controls="comments" aria-selected="false" onclick="loadComments()">Comments</button>
  </li>
</ul>
<div class="tab-content" id="pageTabContent">
  <div class="tab-pane fade show active" id="related" role="tabpanel" aria-labelledby="related-tab">
    <br />

    <div class="row">
      <div class="col text-end">
        <a class="icon-link" href="{{ url_for('home_bp.feed_recent', vulnerability=vulnerability_id, format='atom', source='all') }}" type="application/atom+xml" title="Atom feed">{{ render_icon('rss') }}</a>
        <a class="icon-link" href="{{ url_for('home_bp.feed_recent', vulnerability=vulnerability_id, format='rss', source='all') }}" type="application/atom+xml" title="RSS feed">{{ render_icon('rss-fill') }}</a>
    </div>
  </div>
  {% if linked_vulns %}
    {% for source, vulnerabilities in linked_vulns.items() %}
      {% for vuln_id, vulnerability_data in vulnerabilities %}
        {% if source ==  'nvd' %}
        {{vuln_templates.nvd_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'cvelistv5' %}
        {{vuln_templates.cvelistv5_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'circl' %}
        {{vuln_templates.circl_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data, current_user=current_user)}}
        {% elif source ==  'github' %}
        {{vuln_templates.github_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'gsd' %}
        {{vuln_templates.gsd_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'pysec' %}
        {{vuln_templates.pysec_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'ossf_malicious_packages' %}
        {{vuln_templates.ossf_malicious_packages_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_certbund' %}
        {{vuln_templates.csaf_certbund_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_siemens' %}
        {{vuln_templates.csaf_siemens_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_redhat' %}
        {{vuln_templates.csaf_redhat_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_cisa' %}
        {{vuln_templates.csaf_cisa_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_cisco' %}
        {{vuln_templates.csaf_cisco_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_sick' %}
        {{vuln_templates.csaf_sick_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_ox' %}
        {{vuln_templates.csaf_ox_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_nozominetworks' %}
        {{vuln_templates.csaf_nozominetworks_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'variot' %}
        {{vuln_templates.variot_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
        {%elif source %}
        Other source: {{source}}.
        <pre>{{vulnerability_data|tojson(indent=2)}}</pre>
        {% endif %}
        <br />
      {% endfor%}
    {% endfor%}
  {% endif %}
  </div>
  <div class="tab-pane fade show" id="comments" role="tabpanel" aria-labelledby="comments-tab">
    <br />

    <div class="row">
      <div class="col">
        <button id="buttonNewComment" class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#newComment{{vulnerability_id}}" aria-expanded="false" aria-controls="newComment{{vulnerability_id}}">
          New comment{{ render_icon('chevron-down') }}
        </button>
      </div>
      <div class="col text-end">
          <a class="icon-link" href="{{ url_for('comments_bp.feed_comments', vulnerability=vulnerability_id, format='atom') }}" type="application/atom+xml" title="Atom feed">{{ render_icon('rss') }}</a>
          <a class="icon-link" href="{{ url_for('comments_bp.feed_comments', vulnerability=vulnerability_id, format='rss') }}" type="application/atom+xml" title="RSS feed">{{ render_icon('rss-fill') }}</a>
      </div>
  </div>
    <div class="collapse" id="newComment{{vulnerability_id}}">
      <div id='editor'></div>
      <button class='btn btn-primary' id='savecomment' title="Save the comment">Save</button>
    </div>
    <br /><br />
    <div id="list-comments">
      <div class="d-flex justify-content-center">
        <div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>
      </div>
    </div>
  </div>
</div>
<script>
  let easyMDE = null;
  let SCHEMA = null;
  let COMMENTS = {};

  document.addEventListener("DOMContentLoaded", function() {

    var jsonContainers = document.querySelectorAll(".json-container");
    Array.prototype.forEach.call(jsonContainers, function(jsonContainer) {
      jsonContainer.innerHTML = prettyPrintJson.toHtml(JSON.parse(jsonContainer.innerText));
    });

    fetch("{{ url_for('static', filename='schemas/CIRCL/Security_Advisory_Comment.json') }}")
    .then(response => response.json())
    .then(result => {
      // initialize the JSON editor
      SCHEMA = result;
      initialize_editor(SCHEMA, {});
    }).catch((error) => {
      console.error('Error:', error);
    });
  })

  if (document.getElementById("deleteVulnerability")) {
    document.getElementById("deleteVulnerability").onclick = function(event) {
    if (!confirm('You are going to delete the vulnerability. Are you sure?')) {
        return;
    }
    fetch("{{ url_for('apiv1.default_vulnerability', vulnerability_id=vulnerability_id) }}", {
      method: "DELETE",
          headers: {
            'Content-Type': 'application/json',
          }
    })
    .then(response => {
      if (!response.ok) {
        console.log(response);
      } else {
        window.location="{{ url_for('home_bp.recent') }}";
      }
    })
    .catch((error) => {
      console.log(error);
    });
  };
  }

  document.getElementById("savecomment").onclick = function(event) {
      var json = jsoneditor.getValue();
      json["description"] = easyMDE.value();
      json["vulnerability"] = "{{ vulnerability_id }}";
      data = JSON.stringify(json);
      fetch("{{ url_for('apiv1.comment_comments_list') }}", {
        method: "POST",
        headers: {
          'Content-Type': 'application/json',
        },
        body: data
      })
      .then(res => {
        if (!res.ok) {
          res.json().then(json => {
            document.getElementById("modal-error-text").innerText = json['message'];
            var modal = new bootstrap.Modal(document.getElementById('modalError'), {});
            modal.show();
          });
        } else {
          // reinitializes the form
          window.jsoneditor.setValue({});
          easyMDE.value("");
          easyMDE
          // collapse the view which is containing the form
          new bootstrap.Collapse(document.getElementById("newComment{{vulnerability_id}}"));
          // load the updated list of comments
          loadComments();
        }
      })
      .catch((error) => {
        console.log(error);
      });
    };


  function setEditEvents() {
    var editComments = document.querySelectorAll(".editComment");
    Array.prototype.forEach.call(editComments, function(editComment) {
      editComment.onclick = function(event) {
        var comment_uuid = editComment.getAttribute("comment-uuid");
        window.jsoneditor.setValue(COMMENTS[comment_uuid]);
        easyMDE.value(COMMENTS[comment_uuid]["description"]);
      }
    });
  }


  function setDeleteEvents() {
    var deleteComments = document.querySelectorAll(".deleteComment");
    Array.prototype.forEach.call(deleteComments, function(deleteComment) {
      deleteComment.onclick = function(event) {
        var comment_id = deleteComment.getAttribute("comment-uuid");
        fetch("/api/comment/"+comment_id, {
          method: "DELETE",
              headers: {
                'Content-Type': 'application/json',
              }
        })
        .then(response => {
          if (!response.ok) {
            response.json().then(json => {
            document.getElementById("modal-error-text").innerText = json['message'];
            var modal = new bootstrap.Modal(document.getElementById('modalError'), {});
            modal.show();
          });
          } else {
            loadComments();
          }
        })
        .catch((error) => {
          console.log(error);
        });
      }
    });
  }


  function loadComments() {
    COMMENTS = {};
    if (easyMDE  === null) {
      easyMDE = new EasyMDE({
        element: document.getElementById('root[description]'),
        autoRefresh: { delay: 300 }
      });
    }
    var converter = new showdown.Converter()
    var commentTemplate = _.template(
      '<div class="card">' +
      '<div class="card-body">' +
      '<h5 class="card-title"><%= title %></h5>' +
      '<h6 class="card-subtitle mb-2 text-body-secondary"><%= timestamp %> by <a href="/user/<%= author_login %>"><%= author_name %></a></h6>' +
      '<p class="card-text"><%= description %></p>' +
      '<p class="card-text">Related vulnerabilities: <%= related %></p>' +
      '<button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseJsonComment<%= uuid %>" aria-expanded="false" aria-controls="collapseJsonComment<%= uuid %>">Show JSON</button>&nbsp;' +
      '<div class="collapse" id="collapseJsonComment<%= uuid %>"><br /><pre class="json-container"><%= comment %></pre></div>' +
      '<button class="btn btn-primary editComment" comment-uuid="<%= uuid %>">edit</button>&nbsp;' +
      '<button class="btn btn-danger deleteComment" comment-uuid="<%= uuid %>">delete</button></div>' +
      '</div>');
    fetch("{{ url_for('apiv1.comment_comments_list', vulnerability=vulnerability_id) }}")
    .then(response => response.json())
    .then(result => {
      document.getElementById("list-comments").innerHTML = "";
      if (result.metadata.count == 0) {
        document.getElementById("list-comments").innerHTML = "<p>No comment for this vulnerability. Browse <a href='/comments'>all the comments</a>.</p>";
      }
      result.data
      .sort(function (a, b) {
        return new Date(b.timestamp) - new Date(a.timestamp);
      })
      .map(function (comment) {
        var author = comment.author
        delete comment.author;
        var cardHTML = commentTemplate({
          'comment': JSON.stringify(comment, null, 2),
          'uuid': comment.uuid,
          'title': comment.title,
          'description': converter.makeHtml(comment.description),
          'timestamp': moment(comment.timestamp).fromNow(),
          'related': comment.related_vulnerabilities,
          'author_name': author.name,
          'author_login': author.login
        });
        COMMENTS[comment.uuid] = comment;
        var element = document.createElement("div");
        var element_br = document.createElement("br");
        element.innerHTML = cardHTML;
        document.getElementById("list-comments").appendChild(element.firstChild);
        document.getElementById("list-comments").append(element_br);
      })
    })
    .then(_ => {
      setEditEvents();
      setDeleteEvents();
      return COMMENTS;
    })
    .catch((error) => {
      console.error('Error:', error);
    });
  }


  function initialize_editor(schema, json_object) {
    // Default starting schema
    if(!schema) {
      schema = {}
    }

    // Divs/textareas on the page
    var $schema = schema;
    var $output = document.getElementById('output');
    var $editor = document.getElementById('editor');

    // Default theme
    JSONEditor.defaults.options.theme = 'bootstrap5';
    JSONEditor.defaults.callbacks = {
	      'now': (jseditor_editor, e) => {
		      return new Date(Date.now()).toISOString();
	      }
      }

    window.startval = json_object;

    var jsoneditor;

    var reload = function(keep_value) {
      var startval = (jsoneditor && keep_value)? jsoneditor.getValue() : window.startval;
      window.startval = undefined;

      if (jsoneditor) {
        jsoneditor.destroy();
      }
      jsoneditor = new JSONEditor($editor, {
        // The schema for the editor
        schema: schema,
        // Remove collapse button
        disable_collapse: true,
        // Seed the form with a starting value
        startval: startval,
        // Enable fetching schemas via ajax
        ajax: true,
        // Disable additional properties
        no_additional_properties: false,
        // Require all properties by default
        required_by_default: true,
        show_opt_in: false,
        disable_edit_json: true,
        theme: "bootstrap5",
      });
      window.jsoneditor = jsoneditor;

      // When the value of the editor changes, update the JSON output and validation message
      jsoneditor.on('change',function() {
        var json = jsoneditor.getValue();
      });
    };
    // Start the schema and output textareas with initial values
    $schema.value = JSON.stringify(schema, null, 2);
    reload();
  };
</script>
{% endblock %}
