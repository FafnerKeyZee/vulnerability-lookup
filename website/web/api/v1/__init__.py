from typing import Any

from importlib.metadata import version
from flask import Blueprint
from flask import render_template
from flask import url_for
from flask_restx import Api  # type: ignore[import-untyped]

from vulnerabilitylookup.default import get_config
from website.web.bootstrap import application


apiv1_blueprint = Blueprint(
    "apiv1", __name__, url_prefix="/"
)  # should we put the version in the URL ?


def setup_api(application: Any) -> Api:
    authorizations = {
        "apikey": {
            "type": "apiKey",
            "in": "header",
            "name": "X-API-KEY",
        }
    }

    api = Api(
        apiv1_blueprint,
        title="Vulnerability Lookup API",
        version=version("vulnerabilitylookup"),
        description="API to query Vulnerability Lookup.",
        license="GNU Affero General Public License version 3",
        license_url="https://www.gnu.org/licenses/agpl-3.0.html",
        doc="/doc",
        security="apikey",
        authorizations=authorizations,
        contact_email="info@circl.lu",
        contact_url="https://www.circl.lu",
    )

    @api.documentation  # type: ignore[misc]
    def custom_ui() -> str:
        http_schema = "http" if application.debug else "https"
        return render_template(
            "swagger-ui.html",
            title=api.title,
            specs_url="{}://{}/swagger.json".format(
                http_schema,
                get_config("generic", "public_domain")
            ),
        )

    from website.web.api.v1 import base

    api.add_namespace(base.default_ns, path="/")
    api.add_namespace(base.api_ns, path="/api")

    return api


api = setup_api(application)
