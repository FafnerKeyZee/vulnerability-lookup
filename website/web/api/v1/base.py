from typing import Any
from typing import Dict
from typing import Tuple
from datetime import datetime

import json
import orjson
from flask_login import current_user  # type: ignore[import-untyped]
from flask import request
from flask_restx import Namespace  # type: ignore[import-untyped]
from flask_restx import Resource

from website.lib.utils import validate_json
from website.web.api.v1.common import auth_func
from website.web.bootstrap import vulnerabilitylookup

api_ns = Namespace("api", description="core API operations")
default_ns = Namespace("default", description="default operations")



@api_ns.route('/cve/<string:vulnerability_id>')
@default_ns.route('vulnerability/<string:vulnerability_id>')
class Vulnerability(Resource):  # type: ignore[misc]

    @api_ns.doc(description='Get a vulnerability.')  # type: ignore[misc]
    @default_ns.doc(description='Get a vulnerability.')  # type: ignore[misc]
    def get(self, vulnerability_id: str) -> dict[str, Any] | None:
        with_meta = True if request.args.get('with_meta') else False
        return vulnerabilitylookup.get_vulnerability(vulnerability_id, with_meta=with_meta)

    @api_ns.doc(description='Update a vulnerability.')  # type: ignore[misc]
    @default_ns.doc(description='Update a vulnerability.')  # type: ignore[misc]
    @auth_func
    def patch(self, vulnerability_id: str) -> Tuple[Dict[Any, Any], int]:
        with_meta = True if request.args.get('with_meta') else False
        vuln = vulnerabilitylookup.get_vulnerability(vulnerability_id, with_meta=with_meta)

        result: Dict[Any, Any] = {
            "data": [],
            "metadata": {"count": 0, "offset": 0, "limit": 0},
        }

        if vuln:
            data = api_ns.payload["json_object"]
            # Validate the JSON
            validate_json(data)
            # Add information about the updater in the cveMetadata field
            data["cveMetadata"]["history"].append((current_user.login, datetime.now().strftime("%Y-%m-%dT%H:%M:%S.%fZ")))
            result["data"] = data

        return result, 201


@api_ns.route('/cve/')
@default_ns.route('vulnerability/')
class VulnerabilitiesList(Resource):  # type: ignore[misc]

    @api_ns.doc(description='Create a vulnerability with the CVE version 5 format.')  # type: ignore[misc]
    @default_ns.doc(description='Create a vulnerability with the CVE version 5 format.')  # type: ignore[misc]
    @auth_func
    def post(self) -> Tuple[Dict[Any, Any], int]:
        result: Dict[Any, Any] = {
            "data": [],
            "metadata": {"count": 0, "offset": 0, "limit": 0},
        }

        try:
            vuln = orjson.dumps(default_ns.payload)
            parsed = json.loads(vuln)
        except Exception as e:
            result["data"] = str(e)
            return result, 400

        # Validate the JSON
        validate_json(parsed)

        # Add information about the updater in the cveMetadata field
        if "history" not in parsed["cveMetadata"]:
            parsed["cveMetadata"]["history"] = [(current_user.email, datetime.now().strftime("%Y-%m-%dT%H:%M:%S.%fZ"))]
        else:
            parsed["cveMetadata"]["history"].append((current_user.login, datetime.now().strftime("%Y-%m-%dT%H:%M:%S.%fZ")))

        # print(json.dumps(parsed, indent=4))

        # store the data in kvrocks and update the user

        result["data"] = parsed

        return result, 200


@default_ns.route('redis_up')
@default_ns.doc(description='Check if redis is up and running')
class RedisUp(Resource):  # type: ignore[misc]

    def get(self) -> bool:
        return vulnerabilitylookup.check_redis_up()


@api_ns.route('/dbInfo')
@default_ns.route('info')
@api_ns.doc(description='Get more information about the current databases in use and when it was updated')
class Info(Resource):  # type: ignore[misc]

    def get(self) -> dict[str, Any]:
        return vulnerabilitylookup.get_info()


@api_ns.route('/last')
@default_ns.route('last')
@default_ns.route('last/<int:number>')
@default_ns.route('last/<string:source>')
@default_ns.route('last/<string:source>/<int:number>')
@default_ns.doc(description='Get the last CVEs')
class Last(Resource):  # type: ignore[misc]

    def get(self, source: str | None=None, number: int | None=30) -> list[dict[str, Any]]:
        return [entry for v_id, entry in vulnerabilitylookup.get_last(source, number)]


@api_ns.route('/browse')
@default_ns.doc(description='Get the known vendors')
class Vendors(Resource):  # type: ignore[misc]

    def get(self) -> list[str]:
        return list(vulnerabilitylookup.get_vendors())


@api_ns.route('/browse/<string:vendor>')
@api_ns.doc(description='Get the known products for a vendor')
class VendorProducts(Resource):  # type: ignore[misc]

    def get(self, vendor: str) -> list[str]:
        return list(vulnerabilitylookup.get_vendor_products(vendor))


@api_ns.route('/search/<string:vendor>/<string:product>')
@api_ns.doc(description='Get the the vulnerabilities per vendor and a specific product')
class VendorProductVulnerabilities(Resource):  # type: ignore[misc]

    def get(self, vendor: str, product: str) -> dict[str, list[tuple[str, dict[str, Any]]]]:
        return vulnerabilitylookup.get_vendor_product_vulnerabilities(vendor, product)
