{% extends "main.html" %}
{% block head %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
<script src="https://momentjs.com/downloads/moment.min.js"></script>
{% endblock %}
{% block title %}Comments{% endblock %}
{% block content %}
<h1>Recent comments</h1>
<div id="list-comments">
    <div class="d-flex justify-content-center">
        <div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        var converter = new showdown.Converter()
        var commentTemplate = _.template(
        '<div class="card">' +
        '<div class="card-body">' +
        '<h5 class="card-title"><%= title %> on <%= vulnerability_id %></h5>' +
        '<h6 class="card-subtitle mb-2 text-body-secondary"><%= timestamp %></h6>' +
        '<p class="card-text"><%= description %></p>' +
        '<p class="card-text"><a href="/vuln/<%= vulnerability_id %>">Vulnerability</a></p>' +
        '</div>');
        fetch("{{ url_for('apiv1.comment_comments_list') }}")
        .then(response => response.json())
        .then(result => {
        document.getElementById("list-comments").innerHTML = "";
        if (result.metadata.count == 0) {
            document.getElementById("list-comments").innerHTML = "<p>No comment.</p>";
        }
        result.data
        .sort(function (a, b) {
            return new Date(b.updated_at) - new Date(a.updated_at);
        })
        .map(function (comment) {
            var cardHTML = commentTemplate({
            'id': comment.id,
            'title': comment.data.title,
            'description': converter.makeHtml(comment.data.description),
            'timestamp': moment(comment.data.timestamp).fromNow(),
            'vulnerability_id': comment.data.vulnerability
            });
            var element = document.createElement("div");
            var element_br = document.createElement("br");
            element.innerHTML = cardHTML;
            document.getElementById("list-comments").appendChild(element.firstChild);
            document.getElementById("list-comments").append(element_br);
        })
        })
        .catch((error) => {
        console.error('Error:', error);
        });
    });
</script>
{% endblock %}
