{% extends "main.html" %}
{% from 'bootstrap5/utils.html' import render_messages %}
{% import 'vulnerability_templates.html' as vuln_templates %}

{% block title %}Search a vulnerability{% endblock %}

{%block navbar_links%}
<li class="nav-item">
  <a class="nav-link active" href="{{url_for('search')}}">Search</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="{{url_for('recent')}}">Recent</a>
</li>
{% endblock%}

{% block content %}

{% if not vulnerability_id and not vendor %}
<div class="position-absolute top-50 start-50 translate-middle">
{%else%}
<div class="position-relative top-0 start-50 translate-middle-x">
{%endif%}
<form class="row g-3" role="form" method=post action="search" enctype=multipart/form-data>
  <div class="col-auto">
    <input type="text" class="form-control" id="freetext_search" placeholder="What are you looking for?" name="freetext_search">
  </div>
  <div class="col-auto">
    <button type="submit" class="btn btn-primary mb-3">Search</button>
  </div>
</form>
</div>

{{ render_messages(container=True, dismissible=True) }}

{% if source %}
    {% if source ==  'nvd' %}
    {{vuln_templates.nvd_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
    {% elif source ==  'cvelistv5' %}
    {{vuln_templates.cvelistv5_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
    {% elif source ==  'github' %}
    {{vuln_templates.github_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
    {% elif source ==  'gsd' %}
    {{vuln_templates.gsd_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
    {% elif source ==  'pysec' %}
    {{vuln_templates.pysec_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
    {% elif source ==  'ossf_malicious_packages' %}
    {{vuln_templates.ossf_malicious_packages_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
    {%elif source %}
    Other source: {{source}}.
    <pre>{{vulnerability_data|tojson(indent=2)}}</pre>
    {% endif %}
{% endif %}

{% if linked_vulns %}
  <h5>Vulnerabilites related to the one you searched</h5>
  {% for source, vulnerabilities in linked_vulns.items() %}
    {% for vuln_id, vulnerability_data in vulnerabilities %}
      {% if source ==  'nvd' %}
      {{vuln_templates.nvd_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
      {% elif source ==  'cvelistv5' %}
      {{vuln_templates.cvelistv5_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
      {% elif source ==  'github' %}
      {{vuln_templates.github_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
      {% elif source ==  'gsd' %}
      {{vuln_templates.gsd_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
      {% elif source ==  'ossf_malicious_packages' %}
      {{vuln_templates.ossf_malicious_packages_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
      {%elif source %}
      Other source: {{source}}.
      <pre>{{vulnerability_data|tojson(indent=2)}}</pre>
      {% endif %}
    {% endfor%}
  {% endfor%}
{% endif %}

{%if vendor %}
<div class="position-relative top-0 start-50 translate-middle-x">
  <h1>{{vendor}}</h1>
</div>
<form class="row g-3" role="form" method=post action="search" enctype=multipart/form-data>
<input type="text" class="form-control" id="vendor" name="vendor" value="{{vendor}}" hidden>
<label for="productsList" class="form-label">Search a product</label>
<input class="form-control" list="productslistOptions" id="productsList" name="product" placeholder="Type to search...">
<datalist id="productslistOptions">
  {%for product in vendor_products%}
  <option value="{{product}}">
  {% endfor%}
</datalist>
<label for="vulnsList" class="form-label">Search a vulnerability</label>
<input class="form-control" list="vulnslistOptions" id="vulnsList" name="vendor_vuln" placeholder="Type to search...">
<datalist id="vulnslistOptions">
  {%for vuln in vendor_vulns%}
  <option value="{{vuln}}">
  {% endfor%}
</datalist>
<div class="col-auto">
  <button type="submit" class="btn btn-primary mb-3">Search</button>
</div>
</form>
{% if vp_vulnerabilities %}
  <h5>All the vulnerabilites related to {{vendor}} - {{product}}</h5>
  {% for source, vulnerabilities in vp_vulnerabilities.items() %}
    {% for vuln_id, vulnerability_data in vulnerabilities %}
      {% if source ==  'nvd' %}
      {{vuln_templates.nvd_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
      {% elif source ==  'cvelistv5' %}
      {{vuln_templates.cvelistv5_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
      {% elif source ==  'github' %}
      {{vuln_templates.github_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
      {% elif source ==  'gsd' %}
      {{vuln_templates.gsd_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
      {%elif source %}
      Other source: {{source}}.
      <pre>{{vulnerability_data|tojson(indent=2)}}</pre>
      {% endif %}
    {% endfor%}
  {% endfor%}
{% endif %}
{% endif %}

{% endblock %}
