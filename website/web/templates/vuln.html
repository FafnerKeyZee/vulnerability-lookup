{% extends "main.html" %}
{% import 'vulnerability_templates.html' as vuln_templates %}
{% import 'comment_templates.html' as comment_templates %}

{% block head %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@latest/dist/jsoneditor.min.js"></script>
{% endblock %}

{% block title %}{{source}} - {{vulnerability_id}}{% endblock %}

{% block content %}

{% if source ==  'nvd' %}
{{vuln_templates.nvd_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'cvelistv5' %}
{{vuln_templates.cvelistv5_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'circl' %}
{{vuln_templates.circl_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data, current_user=current_user)}}
{% elif source ==  'github' %}
{{vuln_templates.github_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'gsd' %}
{{vuln_templates.gsd_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'pysec' %}
{{vuln_templates.pysec_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'ossf_malicious_packages' %}
{{vuln_templates.ossf_malicious_packages_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'csaf_certbund' %}
{{vuln_templates.csaf_certbund_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'csaf_siemens' %}
{{vuln_templates.csaf_siemens_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'csaf_redhat' %}
{{vuln_templates.csaf_redhat_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'csaf_cisa' %}
{{vuln_templates.csaf_cisa_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'csaf_cisco' %}
{{vuln_templates.csaf_cisco_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'csaf_sick' %}
{{vuln_templates.csaf_sick_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'csaf_ox' %}
{{vuln_templates.csaf_ox_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'csaf_nozominetworks' %}
{{vuln_templates.csaf_nozominetworks_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{% elif source ==  'variot' %}
{{vuln_templates.variot_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
{%elif source %}
Other source: {{source}}.
<pre>{{vulnerability_data|tojson(indent=2)}}</pre>
{% endif %}

<br />
<ul class="nav nav-tabs" id="pageTab" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="related-tab" data-bs-toggle="tab" data-bs-target="#related" type="button" role="tab" aria-controls="related" aria-selected="true">Related vulnerabilities</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="comments-tab" data-bs-toggle="tab" data-bs-target="#comments" type="button" role="tab" aria-controls="comments" aria-selected="false" onclick="loadComments()">Comments</button>
  </li>
</ul>
<div class="tab-content" id="pageTabContent">
  <div class="tab-pane fade show active" id="related" role="tabpanel" aria-labelledby="related-tab">
    <br />
  {% if linked_vulns %}
    {% for source, vulnerabilities in linked_vulns.items() %}
      {% for vuln_id, vulnerability_data in vulnerabilities %}
        {% if source ==  'nvd' %}
        {{vuln_templates.nvd_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'cvelistv5' %}
        {{vuln_templates.cvelistv5_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'circl' %}
        {{vuln_templates.circl_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data, current_user=current_user)}}
        {% elif source ==  'github' %}
        {{vuln_templates.github_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'gsd' %}
        {{vuln_templates.gsd_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'pysec' %}
        {{vuln_templates.pysec_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'ossf_malicious_packages' %}
        {{vuln_templates.ossf_malicious_packages_view(source=source, vulnerability_id=vuln_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_certbund' %}
        {{vuln_templates.csaf_certbund_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_siemens' %}
        {{vuln_templates.csaf_siemens_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_redhat' %}
        {{vuln_templates.csaf_redhat_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_cisa' %}
        {{vuln_templates.csaf_cisa_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_cisco' %}
        {{vuln_templates.csaf_cisco_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_sick' %}
        {{vuln_templates.csaf_sick_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_ox' %}
        {{vuln_templates.csaf_ox_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'csaf_nozominetworks' %}
        {{vuln_templates.csaf_nozominetworks_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
        {% elif source ==  'variot' %}
        {{vuln_templates.variot_view(source=source, vulnerability_id=vulnerability_id, vulnerability_data=vulnerability_data)}}
        {%elif source %}
        Other source: {{source}}.
        <pre>{{vulnerability_data|tojson(indent=2)}}</pre>
        {% endif %}
        <br />
      {% endfor%}
    {% endfor%}
  {% endif %}
  </div>
  <div class="tab-pane fade show" id="comments" role="tabpanel" aria-labelledby="comments-tab">
    <br />
    <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#newComment{{vulnerability_id}}" aria-expanded="false" aria-controls="newComment{{vulnerability_id}}">
      New comment
    </button>
    <div class="collapse" id="newComment{{vulnerability_id}}">
      <div id='editor'></div>
      <button class='btn btn-primary' id='savecomment' title="Save the comment">Save</button>
      <!-- <textarea id='validate' style='width: 100%; height: 100px; font-family: monospace;' readonly disabled class='form-control'></textarea> -->
    </div>
    <br /><br />
    {{comment_templates.comment_view(1)}}<br />
    {{comment_templates.comment_view(2)}}
  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    fetch("{{ url_for('static', filename='schemas/CIRCL/Security_Advisory_Comment.json') }}")
    .then(response => response.json())
    .then(result => {
      // initialize the JSON editor
      console.log(result);
      initialize_editor_with_schema(result, {});
    }).catch((error) => {
      console.error('Error:', error);
    });
  })


  if (document.getElementById("deleteVulnerability")) {
    document.getElementById("deleteVulnerability").onclick = function(event) {
    if (!confirm('You are going to delete the vulnerability. Are you sure?')) {
        return;
    }
    fetch("{{ url_for('apiv1.default_vulnerability', vulnerability_id=vulnerability_id) }}", {
      method: "DELETE",
          headers: {
            'Content-Type': 'application/json',
          }
    })
    .then(response => {
      if (!response.ok) {
        console.log(response);
      } else {
        window.location="{{ url_for('home_bp.recent') }}";
      }
    })
    .catch((error) => {
      console.log(error);
      // alert(error);
    });
  };
  }

  document.getElementById("savecomment").onclick = function(event) {
      var json = jsoneditor.getValue();
      data = JSON.stringify({json_object: json});
      fetch("{{ url_for('apiv1.comment_comments_list') }}", {
        method: "POST",
        headers: {
          'Content-Type': 'application/json',
        },
        body: data
      })
      .then(res => {
        if (!res.ok) {
          res.json().then(json => {
            console.log(json);
          });
        } else {
          console.log("Comment successfully updated.");
        }
      })
      .catch((error) => {
        console.log(error);
      });
    };

  function loadComments() {
    console.log("Loading comments...");
    fetch("{{ url_for('apiv1.comment_comments_list') }}")
    .then(response => response.json())
    .then(result => {
      console.log(result);
    }).catch((error) => {
      console.error('Error:', error);
    });
  }


  function initialize_editor_with_schema(schema, json_object) {
    // Default starting schema
    if(!schema) {
      schema = {
      }
    }

    // Divs/textareas on the page
    var $schema = schema;
    var $output = document.getElementById('output');
    var $editor = document.getElementById('editor');
    // var $validate = document.getElementById('validate');

    // Buttons

    // var $set_value_button = document.getElementById('setvalue');

    // Default theme
    JSONEditor.defaults.options.theme = 'bootstrap4';
    // JSONEditor.defaults.options.iconlib = 'fontawesome5';

    window.startval = json_object;

    var jsoneditor;

    var reload = function(keep_value) {
      var startval = (jsoneditor && keep_value)? jsoneditor.getValue() : window.startval;
      window.startval = undefined;

      if (jsoneditor) jsoneditor.destroy();
      jsoneditor = new JSONEditor($editor, {
        // The schema for the editor
        schema: schema,

        // Seed the form with a starting value
        startval: startval,

        // Enable fetching schemas via ajax
        ajax: true,

        // Disable additional properties
        no_additional_properties: true,

        // Require all properties by default
        required_by_default: true,

        theme: "bootstrap4",
        iconlib: "fontawesome5",
      });
      window.jsoneditor = jsoneditor;

      // When the value of the editor changes, update the JSON output and validation message
      jsoneditor.on('change',function() {
        var json = jsoneditor.getValue();

        // $output.value = JSON.stringify(json, null, 2);

        var validation_errors = jsoneditor.validate();
        // Show validation errors if there are any
        // if(validation_errors.length) {
        //   $validate.value = JSON.stringify(validation_errors, null, 2);
        // }
        // else {
        //   $validate.value = 'Object is valid.';
        // }

      });
    };

    // Start the schema and output textareas with initial values
    $schema.value = JSON.stringify(schema, null, 2);
    // $output.value = '';

    // When the 'update form' button is clicked, set the editor's value
    // $set_value_button.addEventListener('click',function() {
    //   // jsoneditor.setValue(JSON.parse($output.value));
    // });

    // var refreshBooleanOptions = function(no_reload) {
    //   var boolean_options = document.getElementById('boolean_options').children;
    //   for(var i=0; i<boolean_options.length; i++) {
    //     JSONEditor.defaults.options[boolean_options[i].value] = boolean_options[i].selected;
    //   }
    //   if(!no_reload) reload(true);
    // };


    // refreshBooleanOptions(true);


    reload();
  };

</script>
{% endblock %}
