#! /usr/bin/env python3

import datetime

from flask import render_template

from website.web.bootstrap import application
from website.lib.user_utils import generate_confirmation_token
from website.notifications import emails


def account_recovery(user):
    """Account recovery."""
    token = generate_confirmation_token(user.login)
    expire_time = datetime.datetime.now() + datetime.timedelta(
        seconds=application.config["TOKEN_VALIDITY_PERIOD"]
    )

    plaintext = render_template(
        "emails/account_recovery.txt",
        user=user,
        instance_url=application.config["INSTANCE_URL"],
        token=token,
        expire_time=expire_time,
    )

    emails.send(
        to=user.email,
        subject="[MOSP] Account recovery",
        plaintext=plaintext,
    )


def new_password_notification(user, password):
    """
    New password notification.
    """
    plaintext = render_template("emails/new_password.txt", user=user, password=password)
    emails.send(
        to=user.email,
        subject="[MOSP] New password",
        plaintext=plaintext,
    )


def confirm_account(user):
    """
    Account creation notification.
    """
    token = generate_confirmation_token(user.login)
    expire_time = datetime.datetime.now() + datetime.timedelta(
        seconds=application.config["TOKEN_VALIDITY_PERIOD"]
    )

    plaintext = render_template(
        "emails/account_activation.txt",
        user=user,
        instance_url=application.config["INSTANCE_URL"],
        token=token,
        expire_time=expire_time,
    )

    emails.send(
        to=user.email,
        subject="[MOSP] Account creation",
        plaintext=plaintext,
    )
